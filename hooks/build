#!/bin/bash

if [ $SOURCE_BRANCH = "main" ]
then
  PAYLOAD_URL=$PAYLOAD_URL_PROD
  FRONTEND_URL=$FRONTEND_URL_PROD
  TURNSTILE_SITE_KEY=$TURNSTILE_SITE_KEY_PROD
else
  PAYLOAD_URL=$PAYLOAD_URL_DEV
  FRONTEND_URL=$FRONTEND_URL_DEV
  TURNSTILE_SITE_KEY=$TURNSTILE_SITE_KEY_DEV
fi

docker build -t $IMAGE_NAME --build-arg PAYLOAD_URL=$PAYLOAD_URL --build-arg FRONTEND_URL=$FRONTEND_URL --build-arg TURNSTILE_SITE_KEY=$TURNSTILE_SITE_KEY --build-arg NEXT_PUBLIC_MATOMO_SITE_ID=$NEXT_PUBLIC_MATOMO_SITE_ID --build-arg NEXT_PUBLIC_MATOMO_ENDPOINT=$NEXT_PUBLIC_MATOMO_ENDPOINT .
docker tag $IMAGE_NAME $DOCKER_REPO:$SOURCE_COMMIT
docker push $DOCKER_REPO:$SOURCE_COMMIT
